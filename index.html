<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodCo Pro | Advanced Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar-item:hover { background: #1e293b; border-left: 4px solid #6366f1; }
        .active-tab { background: #4f46e5 !important; border-left: 4px solid #fff; }
        .editable-input { background: transparent; border-bottom: 1px solid #cbd5e1; outline: none; transition: 0.3s; }
        .editable-input:focus { border-bottom: 2px solid #4f46e5; background: #f8fafc; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div class="flex h-screen">
        <aside class="w-72 bg-slate-900 text-white flex flex-col shadow-2xl">
            <div class="p-6 border-b border-slate-800">
                <h1 class="text-2xl font-black text-indigo-400">FOODCO <span class="text-white">PRO</span></h1>
            </div>
            
            <nav class="flex-1 p-4 space-y-2">
                <div onclick="showTab('home')" id="tab-home" class="sidebar-item p-4 rounded-xl flex items-center gap-3 active-tab cursor-pointer"><i class="fas fa-home"></i> Home</div>
                <div onclick="showTab('members')" id="tab-members" class="sidebar-item p-4 rounded-xl flex items-center gap-3 cursor-pointer"><i class="fas fa-users-cog"></i> Edit Members</div>
                <div onclick="showTab('history')" id="tab-history" class="sidebar-item p-4 rounded-xl flex items-center gap-3 cursor-pointer"><i class="fas fa-history"></i> Monthly Archive</div>
                <div onclick="showTab('finance')" id="tab-finance" class="sidebar-item p-4 rounded-xl flex items-center gap-3 cursor-pointer"><i class="fas fa-wallet"></i> Finance</div>
            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto p-8">
            
            <section id="home" class="space-y-6">
                <div class="flex justify-between items-center bg-white p-8 rounded-[2rem] shadow-sm">
                    <div>
                        <h2 class="text-4xl font-black text-slate-800">Overview</h2>
                        <p id="month-display" class="text-indigo-600 font-bold uppercase tracking-widest mt-2"></p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold text-slate-400">CASH IN HAND</p>
                        <p id="total-balance" class="text-3xl font-black text-green-600">₹ 0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                        <h3 class="font-bold mb-4">Last Month Payment Status</h3>
                        <canvas id="paymentHistoryChart"></canvas>
                    </div>
                    <div class="bg-indigo-900 p-6 rounded-3xl text-white shadow-xl">
                        <h3 class="font-bold mb-4">Quick Stats</h3>
                        <div class="space-y-4" id="quick-stats-list">
                            </div>
                    </div>
                </div>
            </section>

            <section id="members" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-bold">Manage Members</h2>
                    <button onclick="openAddMember()" class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg">+ New Member</button>
                </div>
                <div class="bg-white rounded-3xl shadow-lg overflow-hidden border border-slate-200">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 border-b">
                            <tr>
                                <th class="p-5">Name (Fixed)</th>
                                <th class="p-5">Department</th>
                                <th class="p-5">Year</th>
                                <th class="p-5">Phone</th>
                                <th class="p-5">Action</th>
                            </tr>
                        </thead>
                        <tbody id="editable-member-list"></tbody>
                    </table>
                </div>
            </section>

            <section id="history" class="hidden space-y-6">
                <h2 class="text-3xl font-bold">Last Month Data</h2>
                <div class="bg-white p-6 rounded-3xl shadow">
                    <div class="flex gap-4 mb-6">
                        <select id="history-month-selector" class="border p-2 rounded-lg">
                            <option value="January">January</option><option value="February">February</option>
                            </select>
                        <button class="bg-slate-800 text-white px-4 rounded-lg">Filter</button>
                    </div>
                    <div id="history-content" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        </div>
                </div>
            </section>

        </main>
    </div>

    <div id="member-modal" class="fixed inset-0 bg-slate-900/60 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-[2.5rem] w-full max-w-md shadow-2xl">
            <h3 class="text-2xl font-bold mb-6 text-slate-800">Register Student</h3>
            <div class="space-y-4">
                <input type="text" id="m-name" placeholder="Full Name" class="border w-full p-3 rounded-xl bg-slate-50">
                <select id="m-dept" class="border w-full p-3 rounded-xl">
                    <option>AIDS</option><option>AIML</option><option>CSE</option><option>IT</option>
                    <option>ECE</option><option>EEE</option><option>CIVIL</option><option>MECHANICAL</option>
                </select>
                <input type="text" id="m-phone" placeholder="Phone Number" class="border w-full p-3 rounded-xl">
                <div class="flex gap-3 pt-6">
                    <button onclick="closeModal('member-modal')" class="flex-1 font-bold text-slate-500">Cancel</button>
                    <button onclick="saveNewMember()" class="flex-1 bg-indigo-600 text-white font-bold p-4 rounded-2xl">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db;
        const req = indexedDB.open("FoodCoPro_V2", 1);

        req.onupgradeneeded = (e) => {
            db = e.target.result;
            db.createObjectStore("members", { keyPath: "name" }); // Using Name as key (fixed)
            db.createObjectStore("payments", { keyPath: "id", autoIncrement: true });
            db.createObjectStore("attendance_archive", { keyPath: "id", autoIncrement: true });
        };

        req.onsuccess = (e) => {
            db = e.target.result;
            init();
        };

        function init() {
            const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
            const d = new Date();
            document.getElementById('month-display').innerText = months[d.getMonth()] + " " + d.getFullYear();
            loadEditableMembers();
            updateStats();
        }

        function showTab(id) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active-tab'));
            document.getElementById(id).classList.remove('hidden');
            document.getElementById('tab-' + id).classList.add('active-tab');
        }

        // --- MEMBER EDIT LOGIC ---
        function loadEditableMembers() {
            const list = document.getElementById('editable-member-list');
            list.innerHTML = "";
            const tx = db.transaction("members", "readonly");
            tx.objectStore("members").openCursor().onsuccess = (e) => {
                const cursor = e.target.result;
                if(cursor) {
                    const m = cursor.value;
                    list.innerHTML += `
                        <tr class="border-b transition hover:bg-slate-50">
                            <td class="p-5 font-bold text-slate-400">${m.name}</td>
                            <td class="p-5"><input onchange="updateMember('${m.name}', 'dept', this.value)" class="editable-input" value="${m.dept}"></td>
                            <td class="p-5"><input onchange="updateMember('${m.name}', 'year', this.value)" class="editable-input w-20" value="${m.year || '1st'}"></td>
                            <td class="p-5"><input onchange="updateMember('${m.name}', 'phone', this.value)" class="editable-input" value="${m.phone}"></td>
                            <td class="p-5"><button onclick="deleteMember('${m.name}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    `;
                    cursor.continue();
                }
            };
        }

        function updateMember(name, field, value) {
            const tx = db.transaction("members", "readwrite");
            const store = tx.objectStore("members");
            store.get(name).onsuccess = (e) => {
                const data = e.target.result;
                data[field] = value;
                store.put(data);
                console.log(`Updated ${name} ${field} to ${value}`);
            };
        }

        function saveNewMember() {
            const m = {
                name: document.getElementById('m-name').value,
                dept: document.getElementById('m-dept').value,
                phone: document.getElementById('m-phone').value,
                year: '1st Year'
            };
            const tx = db.transaction("members", "readwrite");
            tx.objectStore("members").add(m);
            tx.oncomplete = () => {
                closeModal('member-modal');
                loadEditableMembers();
            };
        }

        function openAddMember() { document.getElementById('member-modal').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // --- STATISTICS & ARCHIVE LOGIC ---
        function updateStats() {
            // Logic to calculate balance from payments store
            let total = 0;
            const tx = db.transaction("payments", "readonly");
            tx.objectStore("payments").openCursor().onsuccess = (e) => {
                const cursor = e.target.result;
                if(cursor) {
                    total += cursor.value.amount;
                    cursor.continue();
                }
                document.getElementById('total-balance').innerText = "₹ " + total.toLocaleString();
            };
        }

        // Initialize Chart
        function renderCharts() {
            const ctx = document.getElementById('paymentHistoryChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr'],
                    datasets: [{
                        label: 'Collections',
                        data: [12000, 15000, 11000, 19000],
                        borderColor: '#4f46e5',
                        tension: 0.4
                    }]
                }
            });
        }
        window.onload = () => setTimeout(renderCharts, 1000);
    </script>
</body>
</html>
